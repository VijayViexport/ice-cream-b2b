generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String          @id @default(uuid())
  email              String          @unique
  password           String
  role               UserRole        @default(BUYER)
  status             UserStatus      @default(PENDING)
  businessName       String
  primaryContactName String
  phone              String
  gstin              String?
  businessAddress    String
  businessType       BusinessType
  yearsInBusiness    Int?
  businessDocUrl     String?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  lastLogin          DateTime?
  addresses          Address[]
  customPricing      CustomPricing[]
  orders             Order[]
  rfqs               RFQ[]
  notifications      Notification[]

  @@map("users")
}

model Product {
  id               String          @id @default(uuid())
  sku              String          @unique
  name             String
  description      String?
  category         String?
  packSize         String
  unitPrice        Decimal         @db.Decimal(10, 2)
  stock            Int             @default(0)
  reservedStock    Int             @default(0)
  reorderThreshold Int             @default(10)
  images           String[]
  nutrition        String?
  allergens        String[]
  featured         Boolean         @default(false)
  isActive         Boolean         @default(true)

  // B2B Packaging Configuration
  unitsPerInnerPack         Int?    // e.g., 6 units per inner pack
  innerPacksPerMasterCarton Int?    // e.g., 4 inner packs per carton
  masterCartonsPerPallet    Int?    // e.g., 80 cartons per pallet
  minimumOrderQuantity      Int     @default(1)
  orderUnitType             OrderUnit @default(EACH)

  // Dimensions & Weight (in metric)
  unitWeight              Decimal? @db.Decimal(10, 2) // kg
  unitDimensions          String?  // "L×W×H cm" e.g., "15×15×10"
  innerPackWeight         Decimal? @db.Decimal(10, 2) // kg
  innerPackDimensions     String?  // "L×W×H cm"
  masterCartonWeight      Decimal? @db.Decimal(10, 2) // kg
  masterCartonDimensions  String?  // "L×W×H cm"
  palletWeight            Decimal? @db.Decimal(10, 2) // kg
  palletDimensions        String?  // "L×W×H cm"
  stackingLimit           Int?     @default(5)

  // Storage & Handling
  storageTemperature    String?  // "-18°C to -22°C"
  shelfLife             String?  // "12 months from manufacturing"
  handlingInstructions  String?  // Special handling notes
  requiresRefrigeration Boolean  @default(false)

  // Compliance & Manufacturing
  fssaiLicense          String?  // FSSAI license number
  manufacturingLocation String?  // "Mumbai, Maharashtra"
  countryOfOrigin       String?  @default("India")
  certifications        String[] // ["ISO 22000", "HACCP", "Halal"]
  ingredients           String?  // Detailed ingredient list
  batchCodeFormat       String?  // "YYYYMMDD-LOT"

  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  customPricing    CustomPricing[]
  orderItems       OrderItem[]
  tieredPricing    TieredPricing[]

  @@map("products")
}

model TieredPricing {
  id          String    @id @default(uuid())
  productId   String
  minQuantity Int
  price       Decimal   @db.Decimal(10, 2)
  unitType    OrderUnit @default(EACH)
  description String?   // "1-3 Master Cartons" or "Best Value"
  product     Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("tiered_pricing")
}

model CustomPricing {
  id        String   @id @default(uuid())
  userId    String
  productId String
  price     Decimal  @db.Decimal(10, 2)
  createdAt DateTime @default(now())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@map("custom_pricing")
}

model Order {
  id                 String        @id @default(uuid())
  orderNumber        String        @unique
  userId             String
  subtotal           Decimal       @db.Decimal(10, 2)
  total              Decimal       @db.Decimal(10, 2)
  status             OrderStatus   @default(PENDING_PAYMENT)
  paymentStatus      PaymentStatus @default(PENDING)
  shippingAddress    String
  orderNotes         String?
  paymentMethod      String?
  paymentProofUrl    String?
  paymentReceivedAt  DateTime?
  trackingNumber     String?
  courier            String?
  dispatchedAt       DateTime?
  deliveredAt        DateTime?
  cancelledAt        DateTime?
  notes              String?
  stockReservedUntil DateTime?
  internalNotes      String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  invoice            Invoice?
  items              OrderItem[]
  user               User          @relation(fields: [userId], references: [id])

  @@map("orders")
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  productId String
  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  lineTotal Decimal @db.Decimal(10, 2)
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product   Product @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Invoice {
  id            String   @id @default(uuid())
  orderId       String   @unique
  invoiceNumber String   @unique
  pdfUrl        String?
  generatedAt   DateTime @default(now())
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

model Address {
  id        String   @id @default(uuid())
  userId    String
  label     String
  street    String
  city      String
  state     String
  pincode   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("addresses")
}

model RFQ {
  id             String    @id @default(uuid())
  rfqNumber      String    @unique
  userId         String
  productId      String?
  quantity       Int
  desiredPrice   Decimal?  @db.Decimal(10, 2)
  message        String?
  status         RFQStatus @default(NEW)
  quotedPrice    Decimal?  @db.Decimal(10, 2)
  quotedLeadTime String?
  adminMessage   String?
  quotedAt       DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id])

  @@map("rfqs")
}

model Settings {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("settings")
}

enum UserRole {
  ADMIN
  BUYER
}

enum UserStatus {
  PENDING
  APPROVED
  BLOCKED
}

enum BusinessType {
  RETAIL_SHOP
  RESTAURANT
  DISTRIBUTOR
  OTHER
}

enum OrderStatus {
  PENDING_PAYMENT
  PAID
  DISPATCHED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum RFQStatus {
  NEW
  IN_REVIEW
  QUOTED
  ACCEPTED
  REJECTED
}

enum OrderUnit {
  EACH
  INNER_PACK
  MASTER_CARTON
  PALLET
}

model Notification {
  id        String               @id @default(uuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  priority  NotificationPriority @default(MEDIUM)
  isRead    Boolean              @default(false)
  readAt    DateTime?
  createdAt DateTime             @default(now())
  expiresAt DateTime?

  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  ORDER_STATUS_CHANGE
  PAYMENT_CONFIRMATION
  PAYMENT_REJECTED
  RFQ_QUOTE_RECEIVED
  ACCOUNT_APPROVED
  ACCOUNT_REJECTED
  LOW_STOCK_ALERT
  PRICE_DROP
  NEW_PRODUCT
  SYSTEM_ANNOUNCEMENT
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
